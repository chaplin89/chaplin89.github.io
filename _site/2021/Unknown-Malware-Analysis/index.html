<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> Unknown malware analysis | chaplinspace </title> <meta name="description" content=" Blog about hacking and other nasty things. "> <meta name="keywords" content="hacking, reverse-engineering, coding, programming"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="chaplin89"> <meta property="article:section" content=""> <meta property="article:tag" content=""> <meta property="article:published_time" content="2021-02-06 00:00:00 +0100"> <meta property="og:url" content="https://chaplin89.github.io/2021/Unknown-Malware-Analysis/"> <meta property="og:title" content=" Unknown malware analysis | chaplinspace "> <meta property="og:image" content="https://chaplin89.github.io"> <meta property="og:description" content=" Blog about hacking and other nasty things. "> <meta property="og:site_name" content="chaplin89"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="chaplinspace"> <meta name="twitter:title" content=" Unknown malware analysis | chaplinspace "> <meta name="twitter:description" content=" Blog about hacking and other nasty things. "> <meta name="twitter:image:src" content="https://chaplin89.github.io"> <!-- Social: Google+ / Schema.org --> <meta itemprop="name" content=" Unknown malware analysis | chaplinspace "> <meta itemprop="description" content=" Blog about hacking and other nasty things. "> <meta itemprop="image" content="https://chaplin89.github.io"> <!-- Canonical link tag --> <link rel="canonical" href="https://chaplin89.github.io/2021/Unknown-Malware-Analysis/"> <link rel="alternate" type="application/rss+xml" title="chaplinspace" href="https://chaplin89.github.io/feed.xml"> <!-- rel prev and next --> <link href="https://chaplin89.github.io/assets/css/all.css" rel="stylesheet"> <link rel="stylesheet" href="https://chaplin89.github.io/assets/css/main.css"> <script text/javascript src="https://chaplin89.github.io/assets/js/jquery-3.4.1.slim.min.js" > </script> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ extensions: [ "MathMenu.js", "MathZoom.js", "AssistiveMML.js", "a11y/accessibility-menu.js" ], jax: ["input/TeX", "output/CommonHTML"], TeX: { extensions: [ "AMSmath.js", "AMSsymbols.js", "noErrors.js", "noUndefined.js", ] } }); </script> <!-- MathJax --> <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"> </script> <script> $(document).ready(function () { jQuery('.fa-bars').on('click', function () { jQuery('.left').toggleClass("active"); }); }); </script> </head> <body> <div class="wrapper"> <div class="header"> <h1 class="logo"><a href="https://chaplin89.github.io/">chaplin<span>space</span></a> </h1> <i class="fas fa-bars"></i> </div> <div class="left"> <header class="site-header"> <div class="container"> <h1 class="logo"><a href="https://chaplin89.github.io/">chaplin<span>space</span></a> </h1> <nav class="navbar"> <ul> <a href="https://chaplin89.github.io/"> <li>Home</li> </a> <a href="https://chaplin89.github.io/about"> <li>About me</li> </a> <a href="https://chaplin89.github.io/feed.xml" target="_blank"> <li>RSS</li> </a> </ul> </nav> <div class="intro"> <p class="lead">Hi, I'm Marco and this blog talks about hacking and other nasty things.</p> <a class="social" href="https://www.github.com/chaplin89"><i class="fab fa-github"></i></a> <div class="donation"> <a href="https://www.savethechildren.org/us/about-us/why-save-the-children"> Did I help? Click here to know what to do. </a> </div> </div> </div> </header> </div> <div class="main"> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <p class="post-meta"><time datetime="2021-02-06T00:00:00+01:00" itemprop="datePublished">Feb 6, 2021</time></p> <h1 class="post-title" itemprop="name headline">Unknown malware analysis</h1> </header> <div class="post-content" itemprop="articleBody"> <ul id="toc" class="section-nav"> <li class="toc-entry toc-h1"><a href="#introduction">Introduction</a></li> <li class="toc-entry toc-h1"><a href="#1---attiraxlxs">1 - Attira.xlxs</a></li> <li class="toc-entry toc-h1"><a href="#2---sanvst">2 - San.vst</a> <ul> <li class="toc-entry toc-h2"><a href="#deobfuscation">Deobfuscation</a></li> <li class="toc-entry toc-h2"><a href="#analysis---antidebug">Analysis - Antidebug</a></li> <li class="toc-entry toc-h2"><a href="#analysis---behaviour">Analysis - Behaviour</a></li> </ul> </li> <li class="toc-entry toc-h1"><a href="#3---piuxlxs">3 - Piu.xlxs</a></li> <li class="toc-entry toc-h1"><a href="#4---schoolexe">4 - School.exe</a> <ul> <li class="toc-entry toc-h2"><a href="#videocardvbs">VideoCard.vbs</a></li> <li class="toc-entry toc-h2"><a href="#executable-files">Executable files</a></li> </ul> </li> </ul><h1 id="introduction"> <a class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h1> <p>This post is about a malware I analyzed in the last few days:</p> <ul> <li><a href="/assets/files/malware.7z">Sample and IDA Db</a></li> <li>Password: <code class="language-plaintext highlighter-rouge">infected</code> </li> </ul> <p>At the time of the writing, the malware is actually undetected by most AV.</p> <p>The malware was downloaded from: <code class="language-plaintext highlighter-rouge">hxxp://52.200.29.1/~arichve/index.php?t=1612270025&amp;q=Download%20KMSpico</code> in a password-protected zip file:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Name: setup.exe
MD5: 393dbb217ad0524bf1af36988fd0d3fe
SHA256: aa777fea172dab773f075f80648c24dfdcb7997c6085917323c30c82fb988626
SHA512: 6dd6bd53bb9f17a9cd1aaf8d0f82f73d2aaca9becf010d7a7a4646a4cd01c5a6f3a211d09e94812fee5478d8c3c85fecc498d4ac8757dbaa037e166ba263fe89
</code></pre></div></div> <p>It seems it is active from 25/01, and it seems to come from Russia. It is divided into different parts, and the first is an SFX.</p> <p>At startup, it will decompress the resource <code class="language-plaintext highlighter-rouge">CABINET</code> (a cab archive indeed) inside <code class="language-plaintext highlighter-rouge">%TEMP%\IXP000.TMP\</code>.</p> <p>The extracted files are:</p> <ol> <li> <code class="language-plaintext highlighter-rouge">Attira.xlxs</code>: base64 encoded file.</li> <li> <code class="language-plaintext highlighter-rouge">San.vst</code>: base64 encoded file.</li> <li> <code class="language-plaintext highlighter-rouge">Pensa.vmw</code>: binary file.</li> <li> <code class="language-plaintext highlighter-rouge">Piu.xlxt</code>: binary file.</li> </ol> <h1 id="1---attiraxlxs"> <a class="anchor" href="#1---attiraxlxs" aria-hidden="true"><span class="octicon octicon-link"></span></a>1 - Attira.xlxs</h1> <p><code class="language-plaintext highlighter-rouge">Attira.xlxs</code> is decoded into <code class="language-plaintext highlighter-rouge">Baciocchi.tif</code> and executed with the command <code class="language-plaintext highlighter-rouge">cmd /c certutil -decode Attira.xlxs Baciocchi.tif &amp; cmd &lt; Baciocchi.tif</code> It is an obfuscated batch file. Most of the instructions are merely invalid and inserted to confuse. The few good instructions are obfuscated by replacing each command’s character with a variable; the prompt will expand during runtime.</p> <p>It is straightforward to remove all the invalid instructions by removing every match with this regex: <code class="language-plaintext highlighter-rouge">^(?!Set|%).*\r\n</code>. To understand the content, it’s enough to execute it; the prompt will show the expanded values:</p> <div class="language-batch highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">findstr</span> <span class="na">/V /R </span><span class="s2">"</span><span class="se">^x</span><span class="s2">BNrnPvttDwqGEHkfIgKhBSsstAiSfcnxclqsMiuANCVJpmuvGVfWYlTIvMzgfjOiCFlzHTCBolAYWHoFzLkzuBvkssUqNRlANNuDgNPMzNONJUM$"</span> <span class="kd">Pensa</span>.wmv  <span class="m">1</span><span class="o">&gt;&gt;</span><span class="kd">Affluisce</span>.com
<span class="nb">certutil</span> <span class="na">-decode </span><span class="kd">San</span>.vst <span class="kd">f</span>
<span class="nb">start</span> <span class="kd">Affluisce</span>.com <span class="kd">f</span>
<span class="nb">ping</span> <span class="m">127</span>.0.0.1 <span class="na">-n </span><span class="m">30</span>
</code></pre></div></div> <p>The command above is ripping the file <code class="language-plaintext highlighter-rouge">Affluisce.com</code> from <code class="language-plaintext highlighter-rouge">Pensa.vmw</code> and decoding <code class="language-plaintext highlighter-rouge">San.vst</code> into <code class="language-plaintext highlighter-rouge">f</code>. At this point is starting <code class="language-plaintext highlighter-rouge">Affluisce.com</code> passing <code class="language-plaintext highlighter-rouge">f</code> as input argument. <code class="language-plaintext highlighter-rouge">Affluisce.com</code> is an AutoIt interpreter, and <code class="language-plaintext highlighter-rouge">f</code> is indeed an obfuscated AutoIt script.</p> <h1 id="2---sanvst"> <a class="anchor" href="#2---sanvst" aria-hidden="true"><span class="octicon octicon-link"></span></a>2 - San.vst</h1> <p>The AutoIt script is obfuscated using control-flow flattening, string encryption, and variable renaming.</p> <h2 id="deobfuscation"> <a class="anchor" href="#deobfuscation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Deobfuscation</h2> <p>After a rapid review, it is possible to understand that a function is used a lot: <code class="language-plaintext highlighter-rouge">aeNNZK</code>. This function is indeed decoding obfuscated strings. I wrote a very simple AutoIt script to replace the calls to this function with the actual value. Is not needed to go this deeper in the analysis of the script, I just wanted to do it for fun:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$sFileName</span> <span class="o">=</span> <span class="s1">'.\f'</span>
<span class="nv">$sOutputFileName</span> <span class="o">=</span> <span class="s1">'.\f_plaintext_string.au3'</span>

Func DeobfuscateString<span class="o">(</span>a,b<span class="o">)</span>
   <span class="p">;</span> Here goes the code of the <span class="k">function </span>that does the decryption: aeNNZK
EndFunc

Func PerformDeobfuscation<span class="o">(</span>ByRef <span class="nv">$FileContent</span>, <span class="nv">$FirstCharacter</span><span class="o">)</span>
   <span class="p">;</span> Call to the <span class="k">function </span>have the syntax:
   <span class="p">;</span>  aennzk<span class="o">(</span><span class="s2">"text"</span>, number<span class="o">)</span>

   <span class="nv">$Start</span> <span class="o">=</span> <span class="nv">$FirstCharacter</span>
   <span class="nv">$FunctionCall</span> <span class="o">=</span> StringInStr<span class="o">(</span><span class="nv">$FileContent</span>, <span class="s2">"aeNNZK"</span>, <span class="nv">$STR_NOCASESENSE</span>, 1, <span class="nv">$Start</span><span class="o">)</span>
   If <span class="nv">$FunctionCall</span> <span class="o">==</span> 0 Then
     <span class="k">return </span>0
   EndIf

   <span class="nv">$FirstParenthesis</span> <span class="o">=</span> StringInStr<span class="o">(</span><span class="nv">$FileContent</span>, <span class="s2">"("</span>, <span class="nv">$STR_NOCASESENSE</span>, 1, <span class="nv">$FunctionCall</span>+1<span class="o">)</span>
   <span class="nv">$FirstQuote</span> <span class="o">=</span> StringInStr<span class="o">(</span><span class="nv">$FileContent</span>, <span class="s1">'"'</span>, <span class="nv">$STR_NOCASESENSE</span>, 1, <span class="nv">$FunctionCall</span>+1<span class="o">)</span>
   <span class="nv">$SecondQuote</span> <span class="o">=</span> StringInStr<span class="o">(</span><span class="nv">$FileContent</span>, <span class="s1">'"'</span>, <span class="nv">$STR_NOCASESENSE</span>, 1, <span class="nv">$FirstQuote</span>+1<span class="o">)</span>
   <span class="nv">$FirstComma</span> <span class="o">=</span> StringInStr<span class="o">(</span><span class="nv">$FileContent</span>, <span class="s2">","</span>, <span class="nv">$STR_NOCASESENSE</span>, 1, <span class="nv">$SecondQuote</span>+1<span class="o">)</span>
   <span class="nv">$SecondParenthesis</span> <span class="o">=</span> StringInStr<span class="o">(</span><span class="nv">$FileContent</span>, <span class="s2">")"</span>, <span class="nv">$STR_NOCASESENSE</span>, 1, <span class="nv">$FirstComma</span>+1<span class="o">)</span>

   <span class="nv">$FirstParameter</span> <span class="o">=</span> StringMid<span class="o">(</span><span class="nv">$FileContent</span>, <span class="nv">$FirstQuote</span>+1, <span class="nv">$SecondQuote</span> - <span class="nv">$FirstQuote</span> - 1<span class="o">)</span>
   <span class="nv">$SecondParameter</span> <span class="o">=</span> StringMid<span class="o">(</span><span class="nv">$FileContent</span>, <span class="nv">$FirstComma</span>+1, <span class="nv">$SecondParenthesis</span> - <span class="nv">$FirstComma</span> - 1<span class="o">)</span>
   <span class="nv">$SecondParameter</span> <span class="o">=</span> StringStripWS<span class="o">(</span><span class="nv">$SecondParameter</span>,   <span class="nv">$STR_STRIPALL</span><span class="o">)</span>
   <span class="nv">$SecondParameter</span> <span class="o">=</span> Number<span class="o">(</span><span class="nv">$SecondParameter</span><span class="o">)</span>

   <span class="nv">$All</span> <span class="o">=</span> StringMid<span class="o">(</span><span class="nv">$FileContent</span>, <span class="nv">$FunctionCall</span>, <span class="nv">$SecondParenthesis</span> - <span class="nv">$FunctionCall</span> + 1<span class="o">)</span>
   <span class="nv">$Computed</span> <span class="o">=</span> <span class="s1">'"'</span> &amp; DeobfuscateString<span class="o">(</span><span class="nv">$FirstParameter</span>, <span class="nv">$SecondParameter</span><span class="o">)</span> &amp; <span class="s1">'"'</span>

   <span class="nv">$FileContent</span> <span class="o">=</span> StringReplace<span class="o">(</span><span class="nv">$FileContent</span>, <span class="nv">$All</span>, <span class="nv">$Computed</span>, 1<span class="o">)</span>
   <span class="k">return</span> <span class="nv">$FunctionCall</span> + StringLen<span class="o">(</span><span class="nv">$Computed</span><span class="o">)</span>
EndFunc

<span class="nv">$hFilehandle</span> <span class="o">=</span> FileOpen<span class="o">(</span><span class="nv">$sFileName</span><span class="o">)</span>
<span class="nv">$Content</span> <span class="o">=</span> FileRead<span class="o">(</span><span class="nv">$hFileHandle</span><span class="o">)</span>
FileClose<span class="o">(</span><span class="nv">$hFileHandle</span><span class="o">)</span>

<span class="nv">$Position</span> <span class="o">=</span> 1
While <span class="nv">$Position</span> &lt;<span class="o">&gt;</span> 0
   <span class="nv">$Position</span> <span class="o">=</span> PerformDeobfuscation<span class="o">(</span><span class="nv">$Content</span>, <span class="nv">$Position</span><span class="o">)</span>
Wend

<span class="nv">$output</span> <span class="o">=</span> FileOpen<span class="o">(</span><span class="nv">$sOutputFileName</span>, <span class="nv">$FO_OVERWRITE</span><span class="o">)</span>
FileWrite<span class="o">(</span><span class="nv">$output</span>, <span class="nv">$Content</span><span class="o">)</span>
FileClose<span class="o">(</span><span class="nv">$output</span><span class="o">)</span>
</code></pre></div></div> <p>After running this script, the output will be much more understandable. The CFG flattening is nothing special; it is possible to recognize a straightforward pattern that will make it useless: only one branch is executed; the others are never.</p> <p>I wrote another AutoIt script to remove this protection:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#NoTrayIcon</span>

<span class="c">#include &lt;Constants.au3&gt;</span>

<span class="nv">$sFileName</span> <span class="o">=</span> <span class="s1">'.\f_plaintext_string.au3'</span>
<span class="nv">$sOutputFileName</span> <span class="o">=</span> <span class="s2">".</span><span class="se">\f</span><span class="s2">_cfg_reconstructed.au3"</span>


Func PerformDeobfuscation<span class="o">(</span>ByRef <span class="nv">$FileContent</span>, <span class="nv">$FirstCharacter</span><span class="o">)</span>

   <span class="nv">$Start</span> <span class="o">=</span> <span class="nv">$FirstCharacter</span>
   <span class="nv">$Switch</span> <span class="o">=</span> StringInStr<span class="o">(</span><span class="nv">$FileContent</span>, <span class="s2">"Switch"</span>, <span class="nv">$STR_NOCASESENSE</span>, 1, <span class="nv">$Start</span><span class="o">)</span>
   If <span class="nv">$Switch</span> <span class="o">==</span> 0 Then
     <span class="k">return </span>0
   EndIf

   <span class="nv">$VarBegin</span> <span class="o">=</span> StringInStr<span class="o">(</span><span class="nv">$FileContent</span>, <span class="s2">"$"</span>, <span class="nv">$STR_NOCASESENSE</span>, 1, <span class="nv">$Switch</span>+1<span class="o">)</span>
   <span class="nv">$VarEnd</span> <span class="o">=</span> StringInStr<span class="o">(</span><span class="nv">$FileContent</span>, @CRLF, <span class="nv">$STR_NOCASESENSE</span>, 1, <span class="nv">$VarBegin</span>+1<span class="o">)</span>
   <span class="nv">$VarName</span> <span class="o">=</span> StringMid<span class="o">(</span><span class="nv">$FileContent</span>, <span class="nv">$VarBegin</span>,  <span class="nv">$VarEnd</span> - <span class="nv">$VarBegin</span> + 1<span class="o">)</span>

   <span class="nv">$VarName</span> <span class="o">=</span> StringStripWS<span class="o">(</span><span class="nv">$VarName</span>,   <span class="nv">$STR_STRIPALL</span><span class="o">)</span>
   <span class="nv">$VarValueBegin</span> <span class="o">=</span> StringInStr<span class="o">(</span><span class="nv">$FileContent</span>, <span class="nv">$VarName</span>, <span class="nv">$STR_NOCASESENSE</span>, 1, <span class="nv">$FirstCharacter</span><span class="o">)</span>
   <span class="nv">$EqualSign</span> <span class="o">=</span> StringInStr<span class="o">(</span><span class="nv">$FileContent</span>, <span class="s1">'='</span>, <span class="nv">$STR_NOCASESENSE</span>, 1, <span class="nv">$VarValueBegin</span><span class="o">)</span>
   <span class="nv">$ValueEnd</span> <span class="o">=</span> StringInStr<span class="o">(</span><span class="nv">$FileContent</span>, @CRLF, <span class="nv">$STR_NOCASESENSE</span>, 1, <span class="nv">$EqualSign</span><span class="o">)</span>

   <span class="nv">$Value</span> <span class="o">=</span> StringMid<span class="o">(</span><span class="nv">$FileContent</span>, <span class="nv">$EqualSign</span> + 1,<span class="nv">$ValueEnd</span> - <span class="nv">$EqualSign</span> + 1<span class="o">)</span>
   <span class="nv">$Value</span> <span class="o">=</span> Number<span class="o">(</span><span class="nv">$Value</span><span class="o">)</span>

   <span class="nv">$BranchStart</span> <span class="o">=</span> <span class="s1">'Case '</span> &amp; <span class="nv">$Value</span>
   <span class="nv">$BranchEnd</span> <span class="o">=</span> <span class="s1">'ExitLoop'</span>

   <span class="nv">$BranchStartPosition</span> <span class="o">=</span> StringInStr<span class="o">(</span><span class="nv">$FileContent</span>, <span class="nv">$BranchStart</span>, <span class="nv">$STR_NOCASESENSE</span>, 1, <span class="nv">$Switch</span><span class="o">)</span> + StringLen<span class="o">(</span><span class="nv">$BranchStart</span><span class="o">)</span>
   <span class="nv">$BranchEndPosition</span> <span class="o">=</span> StringInStr<span class="o">(</span><span class="nv">$FileContent</span>, <span class="nv">$BranchEnd</span>, <span class="nv">$STR_NOCASESENSE</span>, 1, <span class="nv">$BranchStartPosition</span><span class="o">)</span>
   <span class="nv">$Instruction</span> <span class="o">=</span> StringMid<span class="o">(</span><span class="nv">$FileContent</span>, <span class="nv">$BranchStartPosition</span>, <span class="nv">$BranchEndPosition</span> - <span class="nv">$BranchStartPosition</span><span class="o">)</span>

   <span class="nv">$LastChar</span> <span class="o">=</span> StringInStr<span class="o">(</span><span class="nv">$FileContent</span>, <span class="s1">'WEnd'</span>, <span class="nv">$STR_NOCASESENSE</span>, 1, <span class="nv">$BranchEndPosition</span><span class="o">)</span> + StringLen<span class="o">(</span><span class="s1">'WEnd'</span><span class="o">)</span>
   <span class="nv">$Find</span> <span class="o">=</span> StringMid<span class="o">(</span><span class="nv">$FileContent</span>, <span class="nv">$VarValueBegin</span>, <span class="nv">$LastChar</span> - <span class="nv">$VarValueBegin</span><span class="o">)</span>

   <span class="nv">$FileContent</span> <span class="o">=</span> StringReplace<span class="o">(</span><span class="nv">$FileContent</span>, <span class="nv">$Find</span>, <span class="nv">$Instruction</span><span class="o">)</span>
   <span class="k">return</span> <span class="nv">$VarValueBegin</span> + StringLen<span class="o">(</span><span class="nv">$Instruction</span><span class="o">)</span>
EndFunc


<span class="nv">$hFilehandle</span> <span class="o">=</span> FileOpen<span class="o">(</span><span class="nv">$sFileName</span><span class="o">)</span>
<span class="nv">$Content</span> <span class="o">=</span> FileRead<span class="o">(</span><span class="nv">$hFileHandle</span><span class="o">)</span>
FileClose<span class="o">(</span><span class="nv">$hFileHandle</span><span class="o">)</span>

<span class="nv">$Position</span> <span class="o">=</span> 1
While <span class="nv">$Position</span> &lt;<span class="o">&gt;</span> 0
   <span class="nv">$Position</span> <span class="o">=</span> PerformDeobfuscation<span class="o">(</span><span class="nv">$Content</span>, <span class="nv">$Position</span><span class="o">)</span>
Wend

<span class="nv">$output</span> <span class="o">=</span> FileOpen<span class="o">(</span><span class="nv">$sOutputFileName</span>, <span class="nv">$FO_OVERWRITE</span><span class="o">)</span>
FileWrite<span class="o">(</span><span class="nv">$output</span>, <span class="nv">$Content</span><span class="o">)</span>
FileClose<span class="o">(</span><span class="nv">$output</span><span class="o">)</span>
</code></pre></div></div> <p>After some small manual edit (mainly to remove unused variables/functions), the script started to look good. Inside the .zip folder, under <code class="language-plaintext highlighter-rouge">3. Temp Folder\f_deob_manual.au3</code> it is possible to see the deobfuscated version of the script.</p> <h2 id="analysis---antidebug"> <a class="anchor" href="#analysis---antidebug" aria-hidden="true"><span class="octicon octicon-link"></span></a>Analysis - Antidebug</h2> <p>The malware has several kill-switch to complicate the analysis (not very effective if you can read the plain-text source code). The malware will exit if:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">COMPUTERNAME</code> is <code class="language-plaintext highlighter-rouge">DESKTOP-QO5QU33</code> </li> <li> <code class="language-plaintext highlighter-rouge">COMPUTERNAME</code> is <code class="language-plaintext highlighter-rouge">NfZtFbPfH</code> </li> <li> <code class="language-plaintext highlighter-rouge">COMPUTERNAME</code> is <code class="language-plaintext highlighter-rouge">tz</code> </li> <li> <code class="language-plaintext highlighter-rouge">COMPUTERNAME</code> is <code class="language-plaintext highlighter-rouge">ELICZ</code> </li> <li>File exist: <code class="language-plaintext highlighter-rouge">C:\aaa_TouchMeNot_.txt</code> </li> <li>It is possible to ping: <code class="language-plaintext highlighter-rouge">koBFsGVmqaNJBvEubZWGmaLtxgKmN.koBFsGVmqaNJBvEubZWGmaLtxgKmN</code> </li> <li>Assuming <code class="language-plaintext highlighter-rouge">delta</code> is the delta between two GetTickCount with a sleep in the middle, this condition is not respected: <code class="language-plaintext highlighter-rouge">delta - 500 &lt;= SleepMs &lt;= delta + 500</code> </li> <li>If:</li> </ul> \[\sqrt{ (\sum_{n=0}^{42284070}(1/n^2)) * 6} &gt; 3.141\] <p>I found this analysis of a similar malware <a href="https://www.zscaler.com/blogs/security-research/cybergate-rat-and-redline-stealer-delivered-ongoing-autoit-malware-campaigns">here</a> which suggest <code class="language-plaintext highlighter-rouge">NfZtFbPfH</code>, <code class="language-plaintext highlighter-rouge">tz</code> and <code class="language-plaintext highlighter-rouge">ELICZ</code> are common names of commercial AV/Sandboxes, whilst <code class="language-plaintext highlighter-rouge">DESKTOP-QO5QU33</code> could be the name of the author’s PC ¯ \_(ツ)_/¯.</p> <p>The check with <code class="language-plaintext highlighter-rouge">GetTickCount</code> can help detect sandboxes since these environments are often hooking <code class="language-plaintext highlighter-rouge">Sleep</code> not to waste time during the analysis waiting for it. In this case, <code class="language-plaintext highlighter-rouge">delta</code> will not be relatable to <code class="language-plaintext highlighter-rouge">SleepMs</code>.</p> <p>The last one is fun: the infinite sum converges to \(\frac{\pi^2}{6} \approx 1.6449\) and the result of the sum above should be very close to this number. So, at the end, is checking if \(\sqrt{\frac{\pi^2}{6}*6} = \pi &gt; 3.141\). I can only guess this is trying to exploit different approximations in floating-points instructions between normal PCs and sandboxes or emulators to detect these last. For example, I tried to execute this code in a python script, and the script crashed with a “division by zero” error.</p> <h2 id="analysis---behaviour"> <a class="anchor" href="#analysis---behaviour" aria-hidden="true"><span class="octicon octicon-link"></span></a>Analysis - Behaviour</h2> <p>It’s easy at this point to figure out the behavior of some of the functions:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">rlosorgyvobzhliun</code>: anti-debug function.</li> <li> <code class="language-plaintext highlighter-rouge">tDQFdzMzJWonaRSNUVNfnZdcKaxNx</code>: Get something from a c-like struct</li> <li> <code class="language-plaintext highlighter-rouge">IJzlfMsjjUAgSIaNXoCAh</code>: Wrapper for <code class="language-plaintext highlighter-rouge">GetProcAddress</code> </li> <li> <code class="language-plaintext highlighter-rouge">QFNJvesbypwxcgOBAIt</code>: Wrapper for <code class="language-plaintext highlighter-rouge">VirtualProtect</code> </li> <li> <code class="language-plaintext highlighter-rouge">KRYCFcgmvVbQHOKWFZ</code>: Wrapper for <code class="language-plaintext highlighter-rouge">NtUnmapViewOfSection</code> </li> </ul> <p>So what is the script doing? At first, it is waiting for a semaphore opened by <code class="language-plaintext highlighter-rouge">setup.exe</code> to be closed, this means <code class="language-plaintext highlighter-rouge">setup.exe</code> exited.</p> <p>In this second instance, the malware is loading the file <code class="language-plaintext highlighter-rouge">Piu.xlxs</code> in memory and then deleting <code class="language-plaintext highlighter-rouge">Piu.xlxs</code> and <code class="language-plaintext highlighter-rouge">f</code> (the script itself) to cover its traces.</p> <p>At this point, it’s executing a binary payload, embedded in the script as an hex string. This binary exists in two variants, depending on the processor’s bits. This is the 32 bit version, for example: <code class="language-plaintext highlighter-rouge">89 C0 55 31 C0 57 56 53 83 EC 08 8B 4C 24 1C 8B 7C 24 20 C7 01 00 00 00 00 C7 41 04 00 00 00 00 88 44 01 08 83 C0 01 3D 00 01 00 00 75 F2 8D 91 00 01 00 00 31 DB 89 54 24 04 89 C8 31 D2 89 1C 24 89 CE EB 32 C7 04 24 01 00 00 00 31 ED 0F B6 48 08 0F B6 1C 2F 8D 2C 19 8D 54 15 00 0F B6 D2 0F B6 6C 16 08 89 EB 88 58 08 83 C0 01 88 4C 16 08 3B 44 24 04 74 12 8B 0C 24 39 4C 24 24 7E C5 8B 2C 24 83 04 24 01 EB C5 83 C4 08 5B 5E 5F 5D C2 10 00 89 DB 55 57 56 53 83 EC 08 8B 54 24 24 8B 44 24 1C 8B 6C 24 20 85 D2 8B 18 8B 48 04 7E 5B 31 D2 89 5C 24 04 89 2C 24 8B 5C 24 04 83 C3 01 81 E3 FF 00 00 00 89 5C 24 04 0F B6 74 18 08 8B 6C 24 04 8D 0C 0E 0F B6 C9 0F B6 7C 08 08 89 FB 88 5C 28 08 89 F3 8D 34 37 81 E6 FF 00 00 00 88 5C 08 08 0F B6 74 30 08 8B 3C 24 89 F3 30 1C 17 83 C2 01 3B 54 24 24 75 B0 89 EB 89 18 89 48 04 83 C4 08 5B 5E 5F 5D C2 10 00</code></p> <p>It is made by two different assembly functions, separated by a placeholder:</p> <ul> <li>The first is starting at the beginning, right after <code class="language-plaintext highlighter-rouge">89 C0</code> </li> <li>The second begins after <code class="language-plaintext highlighter-rouge">89 DB</code> </li> </ul> <p>The malware puts this binary inside a memory allocated with <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> using the flag <code class="language-plaintext highlighter-rouge">PAGE_EXECUTE_READWRITE</code> to later call the two functions.</p> <p>The script calls them by using <code class="language-plaintext highlighter-rouge">CallWindowProc</code> for the 32-bit variant and by just invoking the pointer for the 64 bits variant. I’m not sure what the reason is; I guess it could be some limitation of AutoIt.</p> <p>The actual calls in pseudocode would be similar to this:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="o">*</span> <span class="n">PiuFileContent</span> <span class="o">=</span> <span class="p">...;</span> <span class="c1">// Content of the file Piu.xlxs</span>
<span class="kt">char</span> <span class="o">*</span> <span class="n">PiuFileLenght</span> <span class="o">=</span> <span class="p">...;</span> <span class="c1">// Lenght of the file Piu.xlxs</span>
<span class="kt">char</span> <span class="n">FirstBuffer</span><span class="p">[</span><span class="mi">272</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">SecondBuffer</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x11</span> <span class="p">};</span>
<span class="kt">int</span> <span class="n">SecondBufferLen</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="n">First</span><span class="p">(</span><span class="n">FirstBuffer</span><span class="p">,</span> <span class="n">SecondBuffer</span><span class="p">,</span> <span class="n">SecondBufferLen</span><span class="p">);</span>
<span class="n">Second</span><span class="p">(</span><span class="n">FirstBuffer</span><span class="p">,</span> <span class="n">PiuFileContent</span><span class="p">,</span> <span class="n">PiuFileLenght</span><span class="p">);</span>
</code></pre></div></div> <p>Where First and Second are respectively the First and the Second assembly function. Without decompiling them, it’s clear the malware is somehow decoding/decrypting the content of <code class="language-plaintext highlighter-rouge">Piu.xlxs</code>. The content of SecondBuffer could be some Key but is not very interesting at this point.</p> <p>The output is given in input to another function that has two parameters:</p> <ul> <li>The first is the output</li> <li>The second is <code class="language-plaintext highlighter-rouge">explorer.exe</code> by default.</li> </ul> <p>It’s effortless at this point to understand where all of this is heading: process hollowing. This guess is made stronger by the fact that the function seems to embed a PE header parser.</p> <p>Dumping the content of <code class="language-plaintext highlighter-rouge">FirstBuffer</code> after the call to <code class="language-plaintext highlighter-rouge">Second</code> shows that indeed it is an exe file.</p> <h1 id="3---piuxlxs"> <a class="anchor" href="#3---piuxlxs" aria-hidden="true"><span class="octicon octicon-link"></span></a>3 - Piu.xlxs</h1> <p>After the AutoIt script successfully decodes <code class="language-plaintext highlighter-rouge">Piu.xlxs</code>, it injects its contents inside <code class="language-plaintext highlighter-rouge">explorer.exe</code> and jumps into it.</p> <p>It is a non-obfuscated 32 bits GUI application. Looking at imports and strings, making some educated guess about what the malware is doing is possible. A couple of things stand out:</p> <ul> <li>HTTP functions from wininet.dll</li> <li>Lots of strings related to SQLite: the exe is embedding the SQLite library</li> <li> <code class="language-plaintext highlighter-rouge">CryptUnprotectData</code> from crypt32</li> </ul> <p>The guess at this point is that the software is reading the SQLite DB of browsers to send login credentials (or cookies) to a website. Since this DB is encrypted so that only a logged user can read it (using <code class="language-plaintext highlighter-rouge">CryptProtectData</code> from crypt32), also finding <code class="language-plaintext highlighter-rouge">CryptUnprotectData</code> in the imports confirm this guess.</p> <p>After decompiling the malware, it turns out the guess was correct, but there’s also a lot more. In details, the operations done by the malware are:</p> <ul> <li>Copying sensitive data (cookies and passwords) from browsers. It support: <ul> <li>Brave Browser</li> <li>Chrome</li> <li>Firefox</li> <li>Opera</li> </ul> </li> <li>Collecting general information on the PC: <ul> <li>Name</li> <li>CPU</li> <li>RAM</li> <li>GPU</li> <li>Installed software</li> </ul> </li> <li>Capture a screenshot</li> <li>Collect *.txt files on desktop</li> <li>Collect wallets credentials from multiple wallets: <ul> <li>Waves Exchange</li> <li>Ledger Live</li> <li>Electrum</li> <li>ElectronCash</li> <li>Electrum-btcp</li> <li>Jaxx</li> <li>Exodus</li> <li>MultiBitHD</li> <li>Monero</li> <li>Exodus Eden</li> <li>Atomic</li> </ul> </li> <li>Download additional malware</li> </ul> <p>In the end, it collects all this information inside a .zip file to upload it on these two websites with a <code class="language-plaintext highlighter-rouge">POST</code> request:</p> <ul> <li><code class="language-plaintext highlighter-rouge">hxxp://fhjweheew21.top/index.php</code></li> <li><code class="language-plaintext highlighter-rouge">hxxp://morteqabq02.top/index.php</code></li> </ul> <p>The last step is to download additional malware from <code class="language-plaintext highlighter-rouge">hxxp://ewsjaseq02.top/download.php?file=lv.exe</code> and put it into <code class="language-plaintext highlighter-rouge">%Temp%\School.exe</code>.</p> <p>A <code class="language-plaintext highlighter-rouge">whois</code> on these two domains shows that they are relatively new: <img src="/assets/images/malware/whois.png" alt="Whois" class="center-image"></p> <h1 id="4---schoolexe"> <a class="anchor" href="#4---schoolexe" aria-hidden="true"><span class="octicon octicon-link"></span></a>4 - School.exe</h1> <p>This file is a Nullsoft scriptable installer that contains three other executables and a VB script:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Name: School.exe
MD5: 6d1b332ccbfaa72d689719d83ca0d4ad
SHA256: 20bb00941c700b886509fae81b7081847c4600f9cf9919270792a07e9bbb72aa
SHA512: 622cac4816b30c10d34f2def84d6df919bb283543fe5166a757f4de54c25a0c4b7ece0acc264b5dfa4d829cfbbb5d7d6388e29aeefbff22943eded27a73c7127
IoC: %Temp%\Pecado
</code></pre></div></div> <h2 id="videocardvbs"> <a class="anchor" href="#videocardvbs" aria-hidden="true"><span class="octicon octicon-link"></span></a>VideoCard.vbs</h2> <p>This script takes the video card’s name and embeds it in the <code class="language-plaintext highlighter-rouge">user-agent</code> of an HTTP request to an IP logger website: <code class="language-plaintext highlighter-rouge">hxxps://iplogger.org/1rUs77</code>. My best guess is that the video card’s information can be used to identify PCs with a good graphic card to do cryptomining.</p> <h2 id="executable-files"> <a class="anchor" href="#executable-files" aria-hidden="true"><span class="octicon octicon-link"></span></a>Executable files</h2> <p>The installer is dropping other 4 files:</p> <ul> <li><code class="language-plaintext highlighter-rouge">4_ico.exe</code></li> <li><code class="language-plaintext highlighter-rouge">6_ico.exe</code></li> <li><code class="language-plaintext highlighter-rouge">vpn_ico.exe</code></li> </ul> <p>All of them seems to be packed. Even if D.I.E. or other tools doesn’t seems to recognize it, it’s easy to figure out it’s Themida, and it’s easy to figure out they were packed at least with the following options enabled:</p> <ul> <li>Anti-debugger detection</li> <li>Advanced api-wrapping</li> <li>Detect file/registry monitors</li> <li>Entry point virtualization</li> </ul> <p>My best guess is that this additional malware is some kind of backdoor that could be used by the author to do cryptomining or other GPU intensive application, but this could be the topic for another post.</p> <p><em><center>To be continued</center></em></p> <aside class="share"> <p>If you liked this article and think others should read it, please share it on <a href="http://twitter.com/share?text=Unknown malware analysis&amp;url=https://chaplin89.github.io/2021/Unknown-Malware-Analysis/&amp;via=chaplinspace" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">Twitter</a> or <a href="https://www.facebook.com/sharer/sharer.php?u=https://chaplin89.github.io/2021/Unknown-Malware-Analysis/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=235');return false;">Facebook</a>.</p> </aside> </div> </article> <aside id="comments" class="disqus"> <div class="container"> <h3><i class="icon icon-comments-o"></i> Comments</h3> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_shortname = 'chaplin89-github-io'; var disqus_identifier = '/2021/Unknown Malware Analysis'; var disqus_title = 'Unknown malware analysis'; var disqus_url = 'https://chaplin89.github.io/2021/Unknown-Malware-Analysis/'; /*var disqus_developer = 1;*/ (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript> Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a> </noscript> </div> </aside> </div> </div> <script type="text/javascript"> var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-141216446-1']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })(); </script> </body> </html>
