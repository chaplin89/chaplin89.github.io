<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> ESET CrackMe Challenge 2015 - Walkthrough | chaplinspace </title> <meta name="description" content=" Blog about hacking and other nasty things. "> <meta name="keywords" content="hacking, reverse-engineering, coding, programming"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="chaplin89"> <meta property="article:section" content=""> <meta property="article:tag" content=""> <meta property="article:published_time" content="2016-01-08 00:00:00 +0100"> <meta property="og:url" content="https://chaplin89.github.io/2016/ESET-CrackMe-Challenge-2015-Walkthrough/"> <meta property="og:title" content=" ESET CrackMe Challenge 2015 - Walkthrough | chaplinspace "> <meta property="og:image" content="https://chaplin89.github.io"> <meta property="og:description" content=" Blog about hacking and other nasty things. "> <meta property="og:site_name" content="chaplin89"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="chaplinspace"> <meta name="twitter:title" content=" ESET CrackMe Challenge 2015 - Walkthrough | chaplinspace "> <meta name="twitter:description" content=" Blog about hacking and other nasty things. "> <meta name="twitter:image:src" content="https://chaplin89.github.io"> <!-- Social: Google+ / Schema.org --> <meta itemprop="name" content=" ESET CrackMe Challenge 2015 - Walkthrough | chaplinspace "> <meta itemprop="description" content=" Blog about hacking and other nasty things. "> <meta itemprop="image" content="https://chaplin89.github.io"> <!-- Canonical link tag --> <link rel="canonical" href="https://chaplin89.github.io/2016/ESET-CrackMe-Challenge-2015-Walkthrough/"> <link rel="alternate" type="application/rss+xml" title="chaplinspace" href="https://chaplin89.github.io/feed.xml"> <!-- rel prev and next --> <link href="https://chaplin89.github.io/assets/css/all.css" rel="stylesheet"> <link rel="stylesheet" href="https://chaplin89.github.io/assets/css/main.css"> <script text/javascript src="https://chaplin89.github.io/assets/js/jquery-3.4.1.slim.min.js" > </script> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ extensions: [ "MathMenu.js", "MathZoom.js", "AssistiveMML.js", "a11y/accessibility-menu.js" ], jax: ["input/TeX", "output/CommonHTML"], TeX: { extensions: [ "AMSmath.js", "AMSsymbols.js", "noErrors.js", "noUndefined.js", ] } }); </script> <!-- MathJax --> <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"> </script> <script> $(document).ready(function () { jQuery('.fa-bars').on('click', function () { jQuery('.left').toggleClass("active"); }); }); </script> </head> <body> <div class="wrapper"> <div class="header"> <h1 class="logo"><a href="https://chaplin89.github.io/">chaplin<span>space</span></a> </h1> <i class="fas fa-bars"></i> </div> <div class="left"> <header class="site-header"> <div class="container"> <h1 class="logo"><a href="https://chaplin89.github.io/">chaplin<span>space</span></a> </h1> <nav class="navbar"> <ul> <a href="https://chaplin89.github.io/"> <li>Home</li> </a> <a href="https://chaplin89.github.io/about"> <li>About me</li> </a> <a href="https://chaplin89.github.io/feed.xml" target="_blank"> <li>RSS</li> </a> </ul> </nav> <div class="intro"> <p class="lead">Hi, I'm Marco and this blog talks about hacking and other nasty things.</p> <a class="social" href="https://www.github.com/chaplin89"><i class="fab fa-github"></i></a> <div class="donation"> <a href="https://www.savethechildren.org/us/about-us/why-save-the-children"> Did I help? Click here to know what to do. </a> </div> </div> </div> </header> </div> <div class="main"> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <p class="post-meta"><time datetime="2016-01-08T00:00:00+01:00" itemprop="datePublished">Jan 8, 2016</time></p> <h1 class="post-title" itemprop="name headline">ESET CrackMe Challenge 2015 - Walkthrough</h1> </header> <div class="post-content" itemprop="articleBody"> <ul id="toc" class="section-nav"> <li class="toc-entry toc-h1"><a href="#introduction">Introduction</a></li> <li class="toc-entry toc-h1"><a href="#library">Library</a> <ul> <li class="toc-entry toc-h2"><a href="#die-analisys">DIE Analisys</a></li> <li class="toc-entry toc-h2"><a href="#entropy">Entropy</a></li> <li class="toc-entry toc-h2"><a href="#rationale">Rationale</a></li> </ul> </li> <li class="toc-entry toc-h1"><a href="#executable">Executable</a> <ul> <li class="toc-entry toc-h2"><a href="#die-analysis">DIE Analysis</a></li> <li class="toc-entry toc-h2"><a href="#entropy-1">Entropy</a></li> <li class="toc-entry toc-h2"><a href="#rationale-1">Rationale</a></li> </ul> </li> <li class="toc-entry toc-h1"><a href="#first-password">First password</a></li> <li class="toc-entry toc-h1"><a href="#second-password">Second Password</a></li> <li class="toc-entry toc-h1"><a href="#third-password">Third password</a></li> <li class="toc-entry toc-h1"><a href="#meet-punchermachineexe">Meet PuncherMachine.exe</a></li> <li class="toc-entry toc-h1"><a href="#4th-condition">4th Condition</a></li> <li class="toc-entry toc-h1"><a href="#meet-punchcardreaderexe">Meet PunchCardReader.exe</a></li> <li class="toc-entry toc-h1"><a href="#conclusion">Conclusion</a></li> </ul><hr> <p><em>Repo for the project: <a href="https://github.com/chaplin89/challenges">https://github.com/chaplin89/challenges</a></em></p> <hr> <p>The ESET CrackMe Challenge 2015 is divided into two parts:</p> <ol> <li>This is the one you download from the ESET website. You are asked to reverse a UPX packed executable and find one password (<strong>Drevokokur</strong>). Then the application decrypts a message with this password that basically asks you to decrypt in the same way some unreferenced data inside the executable. Once decrypted, this unreferenced data gives you a link to download the 2nd part, which is the subject of this document. I won’t discuss the first part any further.</li> <li>The second part is made of an EXE and a DLL. The files to analyze are two: <strong>EsetCrackme2015.exe</strong> and <strong>EsetCrackme2015.dll</strong> </li> </ol> <h1 id="introduction"> <a class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h1> <p>This challenge aims to find three passwords. The application uses various obfuscation techniques, and I have set my goal to get things done with the minimum effort. Given the huge amount of obfuscation/hiding techniques used in this challenge, this paper is only meant as a guide to retrieve the three passwords. I won’t describe many things in detail if you want to deepen some topics, you can check the repo linked at the beginning of the post.</p> <p>Its structure is as follows:</p> <table> <thead> <tr> <th> </th> <th> </th> </tr> </thead> <tbody> <tr> <td>Analysis</td> <td>Is divided into subfolders. Every subfolder’s name is the ID of a resource (see below). Subfolders contain files related to my analysis, IDA DBs, tools I wrote, and, eventually, the resource itself decrypted (if the original is encrypted).</td> </tr> <tr> <td>Resources</td> <td>Contains raw resources dumped from the challenge.</td> </tr> <tr> <td>Utility</td> <td>Contains utility I wrote to analyze the .net stuff</td> </tr> <tr> <td>Resources.xlsx</td> <td>An overall description of all the resources.</td> </tr> <tr> <td>EsetCrackMe2015.exe<br>EsetCrackMe2015.dll</td> <td>The challenge itself.</td> </tr> </tbody> </table> <p>For this challenge, I used:</p> <ul> <li>IDA Pro as disassembler/frontend of WinDBG for debugging native code (either for the user mode and the kernel-mode part)</li> <li> <a href="http://ntinfo.biz/index.html">DIE (Detect it easy)</a> to analyze the files</li> <li> <a href="https://www.jetbrains.com/decompiler/">dotPeek</a> to reverse the .net stuff</li> <li> <a href="https://github.com/0xd4d/de4dot">de4dot</a> mainly to rename obfuscated symbols</li> <li>Other tools I wrote from time to time</li> </ul> <h1 id="library"> <a class="anchor" href="#library" aria-hidden="true"><span class="octicon octicon-link"></span></a>Library</h1> <h2 id="die-analisys"> <a class="anchor" href="#die-analisys" aria-hidden="true"><span class="octicon octicon-link"></span></a>DIE Analisys</h2> <p><img src="/assets/images/DIE_DLL.png" alt="DIE DLL" class="center-image"></p> <h2 id="entropy"> <a class="anchor" href="#entropy" aria-hidden="true"><span class="octicon octicon-link"></span></a>Entropy</h2> <p><img src="/assets/images/DIE_DLL_Entropy.png" alt="DIE DLL Entrophy" class="center-image"></p> <h2 id="rationale"> <a class="anchor" href="#rationale" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rationale</h2> <p>The DLL is just a collection of resources with a very simple schema:</p> <ul> <li>2 Byte: ID</li> <li>4 Byte: Size</li> <li>N Byte: data Some of them are encoded/encrypted, others are not. The encryption/encoding schema varies, see Resources.xlsl.</li> </ul> <p>I’ll often reference these resources.</p> <h1 id="executable"> <a class="anchor" href="#executable" aria-hidden="true"><span class="octicon octicon-link"></span></a>Executable</h1> <h2 id="die-analysis"> <a class="anchor" href="#die-analysis" aria-hidden="true"><span class="octicon octicon-link"></span></a>DIE Analysis</h2> <p><img src="/assets/images/DIE_EXE.png" alt="DIE Executable" class="center-image"></p> <h2 id="entropy-1"> <a class="anchor" href="#entropy-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Entropy</h2> <p><img src="/assets/images/Die_EXE_Entropy.png" alt="DIE Executable Entrophy" class="center-image"> Note: the file is small and a large portion of it is made of digital signature (high entropy) so the DIE analysis is distorted.</p> <h2 id="rationale-1"> <a class="anchor" href="#rationale-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rationale</h2> <p>The application decrypts resource with ID <code class="language-plaintext highlighter-rouge">0x0101</code> using the key “<strong>Irren%20ist%20menschlich</strong>” (resource ID <code class="language-plaintext highlighter-rouge">0x0003</code>), then enters in a loop.</p> <p>In this loop, it repeatedly calls the decrypted resource until its result is not zero. At that time, it waits for some events to occur (see below), then it starts from the beginning.</p> <p>The application also starts a thread that makes it communicate with every entity that requests something through the PIPE <code class="language-plaintext highlighter-rouge">\\.\pipe\EsetCrackmePipe</code> (<code class="language-plaintext highlighter-rouge">ID 0x0002</code>) with a simple protocol:</p> <ol> <li>Request <ol> <li>1 byte: Type of request</li> <li>2 bytes: ID</li> </ol> </li> <li>Response <ol> <li>1 byte: Type of request</li> <li>2 bytes: ID</li> <li>4 bytes: size (if the request is of type 1)</li> <li>N byte: data (if the request is of type 1) Type 1 is used to retrieve resources; type 2 is used to signal events.</li> </ol> </li> </ol> <h1 id="first-password"> <a class="anchor" href="#first-password" aria-hidden="true"><span class="octicon octicon-link"></span></a>First password</h1> <p>In the decrypted routine that is called by the application, a lot of things can happen.</p> <p>The first time the resources with ID<code class="language-plaintext highlighter-rouge"> 0x0102</code>, <code class="language-plaintext highlighter-rouge">0x0103</code>, <code class="language-plaintext highlighter-rouge">0x0104</code> are loaded:</p> <ol> <li>The first is a (simple) virtual machine.</li> <li>The second is the bytecode of a program that uses <a href="https://www.trustwave.com/Resources/SpiderLabs-Blog/Analyzing-Malware-Hollow-Processes/">process hollowing</a> to inject the resource <code class="language-plaintext highlighter-rouge">0x0151</code> in Svchost.exe.</li> <li>The third is the bytecode of a program that can take the resource data, a path in input, and dump the resource in the path. I leave out the VM analysis for the moment because it is not important for the first password. All we need to know for now is that this program injects something in svchost.exe</li> </ol> <p>The context can easily see this because if you break at <code class="language-plaintext highlighter-rouge">0x00060AEC</code> (the VM main loop), you’ll see that at some time, the process svchost.exe is created suspended, so it’s easy to guess what’s going on. Also, if you look for the processes linked with the GUI that stands out when you open EsetCrackme2015.exe, you’ll see that it is svchost.exe and not EsetCrackme2015.exe</p> <p>We can see what is injected by dumping the resource on disk after decryption (<a href="https://github.com/chaplin89/challenges/tree/master/ESET-2015/Resources/0x0151_Injected/Injected.exe">Resources/0x0151_Injected/Injected.exe</a>). It doesn’t use any debugging protection, so you can attach your debugger to the right instance of svchost.exe and dump process data.</p> <p>Analyzing the injected program, we can see that it is a straightforward dialog-based application:</p> <p><img src="/assets/images/Crackme.png" alt="Eset Crackme" class="center-image"></p> <p>It computes a hash on the inserted password and then compares them against a pre-loaded hash on the button click events. These hashes are loaded from the main application through the PIPE, then decrypted (ID <code class="language-plaintext highlighter-rouge">0xBB01</code>). The algorithm which is used to compute hash is SHA-1, so I consider this a dead end.</p> <p>The application also starts a thread that replaces the <code class="language-plaintext highlighter-rouge">DlgProc</code> at runtime via <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms633591%28v=vs.85%29.aspx"><code class="language-plaintext highlighter-rouge">SetWindowLong</code></a>.</p> <p>The new <code class="language-plaintext highlighter-rouge">DlgProc</code> is almost useless. Still, it intercepts the OnClick event, and it leads us to the first password because it encodes the first inserted password with a slightly modified BASE64 and compares the result to a pre-loaded string (for other details, see <code class="language-plaintext highlighter-rouge">0x00072360</code>). This string is the resource <code class="language-plaintext highlighter-rouge">0xBB02</code>.</p> <p>Applying the algorithm conversely on the loaded string, we can see the first password: <strong>Devin Castle</strong>, a nice place in Slovakia:</p> <p><img src="/assets/images/DevinCastle.jpg" alt="Devin castle" class="center-image"></p> <h1 id="second-password"> <a class="anchor" href="#second-password" aria-hidden="true"><span class="octicon octicon-link"></span></a>Second Password</h1> <p>Inserting the first password lets us move to the second stage of the challenge: the driver.</p> <p>When a password is inserted correctly, an event is signaled through the PIPE. The thread that manages the PIPE in the main application records the event and wakes up the main thread. The main thread re-runs the decrypted DLL’s routine. Basing on the event signaled, it can start the VM program <code class="language-plaintext highlighter-rouge">0x104</code> to write some resources somewhere. In the case of the 1st password, this resource is the one with ID<code class="language-plaintext highlighter-rouge"> 0x0152</code>, and the place is the application working directory.</p> <p>This resource is a zip folder that contains a Win32 legacy driver that you have to install.</p> <p>This driver is a ramdisk, its architecture is more or less the same that you’ll find an example on the Microsoft website (see: <a href="https://github.com/chaplin89/challenges/tree/master/ESET-2015/Analysis/0x0152_Drv.zip/RAMDISK">Analysis/0x0152_Drv.zip/RAMDISK</a>). You can read that code to understand the main functionality of this driver.</p> <p>There are, of course, some important differences that I’ll explain.</p> <p>The routine that changes most is the <code class="language-plaintext highlighter-rouge">DispatchReadWrite</code>: basically, the principle is that you write something in the ramdisk, then when you read it, the driver decrypt what you wrote on the fly. One of the differences between this driver and the MS example is that this driver does not create any symbolic link, so every read/write is done by creating a handle to the device name that is <code class="language-plaintext highlighter-rouge">\\?\GLOBALROOT\Device\45736574\</code>.</p> <p>The driver in the “<code class="language-plaintext highlighter-rouge">add</code>” routine starts many threads that use the PIPE to communicate with the application. The application gives the driver the string “<strong>ESETConst</strong>” (<code class="language-plaintext highlighter-rouge">ID 0xAA02</code>) that is used as the name of a registry key and a program for the virtual machine that lies inside the driver (<code class="language-plaintext highlighter-rouge">ID 0xAA06</code>).</p> <p>This program is the one that decrypts what you write inside the ramdisk.</p> <p>Here we are forced to analyze this VM. I wrote a VM bytecode decompiler in an assembly-like language. You can find it inside <a href="https://github.com/chaplin89/challenges/tree/master/ESET-2015/Analysis/0x0102_VirtualMachine/VMDecompiler">Analysis/0x0102_VirtualMachine/VMDecompiler</a> (it has some minor bug but should always produce valid disassembly):</p> <p><img src="/assets/images/vm_decompiler.png" alt="Decompiler" class="center-image"></p> <p>The VM that runs inside the driver is slightly different from the one that runs inside the application. In particular, the offset of the header fields is different.</p> <p>The header contains the following fields:</p> <ul> <li>2 Byte: Signature</li> <li>4 Byte: Size</li> <li>4 Byte: MainOffset</li> <li>4 Byte: library flag The signature is compared against a constant (“1337” for app VM, “3713” for driver VM). If the signature does not match, the execution begins from the 1st byte following the header (decryption stub); if it matches, the execution begins from the MainOffset byte following the header.</li> </ul> <p>VM is quite simple. It can support 255 opcodes, but only 15 of them are implemented. If the program contains not supported opcodes, the program terminates.</p> <p>The VM virtualize a stack, 4 MB, and a CPU with 16 registers:</p> <ol> <li>Register from 0 to 5 are GP</li> <li>6 is SP</li> <li>7 is the beginning of the loaded program</li> <li>8 is loaded program size</li> <li>9 is the library flag</li> <li> <p>Register from 10 to X, where <code class="language-plaintext highlighter-rouge">10&lt;X&lt;16</code> is a constant passed to the VM, contains some DWORD passed to the VM (input data) Here is a brief description of opcodes, for further reference, see the file <a href="https://github.com/chaplin89/challenges/tree/master/ESET-2015/Analysis/0x0102_VirtualMachine/VMOpcodes.xlsx">Analysis/0x0102_VirtualMachine/VMOpcodes.xlsx</a>:</p> </li> <li>Terminate the program.</li> <li>Move data. The destination is a register.</li> <li>(Native) Call. Make a call to the argument.</li> <li>Call the library. Arguments are the hash of the name of a (loaded) library and the hash of the name of a function exported by the library.</li> <li>Push argument in the stack (load argument in memory pointed by SP and then decrement SP).</li> <li>Pop dword from the stack into a register (copy dword from memory pointed by SP into register then increment SP).</li> <li>Logical operations, the first operand is a register. The operation could be: not equal, equal, minor. If the condition is met, a flag is set.</li> <li>Jump. This can be conditional. In that case, the IP is updated if the flag is set. (Virtual) Call. Push IP, then change it with argument.</li> <li>Pop dword from the stack into IP.</li> <li>Arithmetic operations, the first operand is a register. The operation could be: add, sub, left shit, right shift, ROR, ROL, module.</li> <li>Allocate memory. The operand is the size. The pointer to allocated memory is saved in Register 0.</li> <li>Deallocate memory. The operand is the pointer. The program pointed by the argument is loaded in memory takes the place of the loaded one.</li> <li>Terminate the program. This is called when an invalid opcode is found.</li> </ol> <p>The VM iterates through every byte in the program and calls the appropriate handler until it finds an exit opcode or an invalid one. The handlers accept a structure (Context) in input that contains the status of the CPU.</p> <p>The programs that run inside the driver could be seen in <a href="https://github.com/chaplin89/challenges/tree/master/ESET-2015/Analysis/0x0152_Drv.zip/VM%20Programs">Analysis/0x0152_Drv.zip/VM Programs</a>. In this program, the odd thing is that the registry key (ESETConst) is checked against null but seeing the dispatch RW routine, it is easy to spot that the VM can’t start if the key is null.</p> <p>In fact, reversing the algorithm, we find the 2nd password: <strong>Barbakan Krakowski</strong> a building in Krakow:</p> <p><img src="/assets/images/BarbakanKrakowski.jpg" alt="Barbakan Krakowki" class="center-image"></p> <p>I wrote a program to emulate the behaviors of the VM in a high-level language. In <a href="https://github.com/chaplin89/challenges/tree/master/ESET-2015/Analysis/0x0152_Drv.zip/DriverVMEmulator">Analysis/0x0152_Drv.zip/DriverVMEmulator</a>, there is a software that decrypts the resource 0x0155 as the driver would do. It can also run the algorithm conversely to find what the registry key should be: Reversing is great.</p> <p>The result of the decryption is this bitmap:</p> <p><img src="/assets/images/Bitmap.png" alt="Decrypted" class="center-image"></p> <h1 id="third-password"> <a class="anchor" href="#third-password" aria-hidden="true"><span class="octicon octicon-link"></span></a>Third password</h1> <p>Guessing the 2nd password lets us move to the third part of the challenge.</p> <p>When you guess the 2nd password, the application writes the resource with <code class="language-plaintext highlighter-rouge">ID 0x0153</code>, <code class="language-plaintext highlighter-rouge">0x0154</code> in its working folder. These are two .net applications called PunchCardReader.exe and PuncherMachine.exe.</p> <p>Both of them are windows form applications. Both are obfuscated with a custom obfuscator (I guess). The obfuscation schema is the same, and it is straightforward:</p> <p>Most of the obfuscation is based on splitting function bodies into different cases inside a switch <code class="language-plaintext highlighter-rouge">(num1^num2)</code>. One of the integers does not change among different loops, but the other can be reassigned inside the various cases. In this way, the next time the loop is executed, it can enter in another case. Every case usually ends with a branch to the switch address:</p> <p><img src="/assets/images/DotnetDecompiled.png" alt="DotNet Decompiled" class="center-image"></p> <p>Strings are not directly visible. They are merged together and constitute a blob of data. There are some stub methods, one for each string, that know how to extract strings from this blob of data. As various obfuscation schemas do, invalid C# names are used. In IL, you can, for example, re-use the same name for different types because, in IL, you always have to fully-qualify everything you use, so there is no ambiguity. My first attempt to understand what the software does was to write a plugin for de4dot. I wrote the skeleton of the obfuscator, but then I realized that important functions are very small and it is not hard to understand what they do, so I’ve chosen a different approach:</p> <p>First of all a <code class="language-plaintext highlighter-rouge">“de4dot –un-name !.*”</code> is by default. So I’ve used dotPeek to decompile the program and recreate the VS project. With very few changes (mainly moving variable declaration) and some textual parsing (see <a href="https://github.com/chaplin89/challenges/tree/master/ESET-2015/Utility/PunchStringDeob">Utility/PunchStringDeob</a>), I was able to compile both projects.</p> <p>In these applications, resources loaded from the main app are decrypted with the AES algorithm in ECB mode (which I think could explain a lack of entropy at the end of DLL). The key is an MD5 hash computed against the body of some methods that has a particular attribute and the attribute itself. Of course, when I recreated the project in VS, the MD5 hash has changed, so I wrote a program that emulates the hash computation using the original file as input, then I hardcoded the key in the recompiled programs to make things work (see <a href="https://github.com/chaplin89/challenges/tree/master/ESET-2015/Utility/ExtractKey">Utility/ExtractKey</a>).</p> <h1 id="meet-punchermachineexe"> <a class="anchor" href="#meet-punchermachineexe" aria-hidden="true"><span class="octicon octicon-link"></span></a>Meet PuncherMachine.exe</h1> <p>Once open, it shows this image:</p> <p><img src="/assets/images/PuncherMachine.png" alt="Punchcher machine 1" class="center-image"></p> <p>It uses PIPE to check if EsetCrackme2015.exe is open. If it isn’t, it won’t start.</p> <p>Of course, here I made an “ignorant” attempt to make the application load the file extracted from the driver. Of course, it didn’t work.</p> <p>There are some odd things inside <code class="language-plaintext highlighter-rouge">PuncherMachine.exe</code> that promptly stand out.</p> <p>It tries to refer to a resource named “<code class="language-plaintext highlighter-rouge">resource0</code>” and there is no such resource in the assembly. It tries to retrieve a resource from the main application with ID<code class="language-plaintext highlighter-rouge"> 0xFF03</code>, and there is no such resource in the DLL. You can make the application find <code class="language-plaintext highlighter-rouge">resource0</code> into the assembly, or you can perform a “man in the middle” attack through the PIPE to inject the resource; the result is pretty much the same: a hash is computed on this resource and is checked against the hash of the file that you choose from the file dialog. If it matches, the software leads you to the 2nd stage; if it doesn’t match, an “<code class="language-plaintext highlighter-rouge">Invalid punchcard!</code>” message is shown.</p> <p>If the application doesn’t find one or the other, it checks the hash of the input file against an unknown hash (resource ID <code class="language-plaintext highlighter-rouge">0xFF02</code>): <code class="language-plaintext highlighter-rouge">95eceaa118dd081119e26be1c44da2cb</code>. Then the check fails because I don’t have the file that has that MD5 hash, but maybe I’m missing something here. In fact, I’m quite sure that there is far more than it seems in the bitmap. Of course, a bitmap full of noise seems very strange in a challenge that is stuffed with mysteries. My guess is that there is another bitmap that can be decoded starting from the first, and that bitmap has the required hash. By the way, I haven’t spent time on this because the bitmap plays a minor role in this process, and it is not functional to retrieve the 3rd password. Also, as I’ll explain later, this bitmap, although I think it is decoded well, does not allow me to complete the challenge.</p> <p>At this point, I made the recompiled software load “<code class="language-plaintext highlighter-rouge">resource0”</code>, which is my bitmap.</p> <p>Selecting a valid bitmap makes the GUI change:</p> <p><img src="/assets/images/PuncherMachine_2.png" alt="Puncher machine 2" class="center-image"></p> <p>I’m asked to insert two strings: calibration code one and calibration code 2.</p> <p>Seeing the handler to the “Calibrate!” button click, I can see that “<code class="language-plaintext highlighter-rouge">Calibration code 1</code>” is given in input to a method of an assembly.</p> <p>The assembly is obtained through PIPE (resource ID <code class="language-plaintext highlighter-rouge">0xFF04</code>), and the method is called “<code class="language-plaintext highlighter-rouge">createMethod</code>”.</p> <p>After dumping the assembly on the disk, I could analyze it (see <a href="https://github.com/chaplin89/challenges/tree/master/ESET-2015/Analysis/0xFF04_CalibrationDynMethod.dll/CalibrationDynMethod">Analysis/0xFF04_CalibrationDynMethod.dll/CalibrationDynMethod</a> for full code). The assembly is very simple and, luckily, is not obfuscated. It can create the skeleton of a method with Reflection.Emit classes. In this skeleton, some instructions are missing. The method uses the input constants as hashes to decide which opcode to emit, so understanding what the generated function should do is the first step to decide which opcode should be there. It is not that hard because it contains some hardcoded constants, and searching these constants on Google, it comes out that this is the “Knuth Hash” algorithm and the missing instructions are then: ldarg.0 and mul.</p> <p>Basing on this, the Calibration code 1 should be <code class="language-plaintext highlighter-rouge">0364ABE72D29C96C</code> (see <a href="https://github.com/chaplin89/challenges/tree/master/ESET-2015/Analysis/0xFF04_CalibrationDynMethod.dll/CalibrationDynMethod_HashTable.txt">Analysis/0xFF04_CalibrationDynMethod.dll/CalibrationDynMethod_HashTable.txt</a>).</p> <p>The created method is then called inside a loop. Every char of the calibration code two is added to a char in a list, and then the Knuth Hash is computed based on this input. Every hash in output, then, should be the key of a hashtable for the “calibration process” to be successful. This hashtable is the resource <code class="language-plaintext highlighter-rouge">0xFF00</code>.</p> <p>It comes out that the only string that met this condition is “<strong>Infant Jesus of Prague</strong>” (that it is also the third password), a statue in Prague:</p> <p><img src="/assets/images/InfantJesus.jpg" alt="Infant Jesus of prague" class="center-image"></p> <h1 id="4th-condition"> <a class="anchor" href="#4th-condition" aria-hidden="true"><span class="octicon octicon-link"></span></a>4th Condition</h1> <p>Honestly, at this point, my interest in the challenge really dropped down. It was fun to learn IL and C# a little bit to found the 2nd password, and I was expecting some kind of escalation, but the third one is actually way too boring and way too easy compared to the 2nd. So my expectations were disillusioned.</p> <p>The truth is that it was hard to stay in the right mood in order to continue the challenge, and I continued until I could do things that required limited effort, but I gave up at the real end because I thought it wasn’t fun anymore.</p> <p>By the way, if you want, I have paved the way, and you have all you need in order to finish the challenge; maybe you can prove I was wrong.</p> <p>Ok, enough blah-blah, back to the challenge.</p> <p>If you look inside <code class="language-plaintext highlighter-rouge">0x10000CDD</code>, you’ll see that there are four conditions to meet in order to make the application show you a greeting message. Three of them are events fired when you enter the right passwords. A 4th condition is an event fired by PunchCardReader.exe; we’ll get there.</p> <p>What matter for the moment is that when you enter the valid calibration codes, the GUI changes:</p> <p><img src="/assets/images/4thCondition.png" alt="Calibrated" class="center-image"></p> <p>As you can see on the “PunchIt!” button handler, it can encode the string that you insert in the bitmap that is then written on disk with the name punch_card_XXX.bmp (where XXX is in the range 000-999) with a fancy animation and a very relaxing background noise.</p> <p>The next step is to figure out what should be encoded in bitmaps.</p> <h1 id="meet-punchcardreaderexe"> <a class="anchor" href="#meet-punchcardreaderexe" aria-hidden="true"><span class="octicon octicon-link"></span></a>Meet PunchCardReader.exe</h1> <p>Once opened, it shows this dialog:</p> <p><img src="/assets/images/PunchcardReader.png" alt="Punchcard reader" class="center-image"></p> <p>This is another windows form application. It just has one button in the interface: “<code class="language-plaintext highlighter-rouge">Read punch card</code>”.</p> <p>The principle, of course, is to produce some “punch cards” from PuncherMachine.exe then read these “punch cards” from PunchCardReader.exe.</p> <p>In the disassembled program, it could be easily seen that punch cards are decoded into a string. These strings are passed to the method of an assembly.</p> <p>The assembly is the resource <code class="language-plaintext highlighter-rouge">0xFF05</code>, and it is very similar to the former. It now accepts a string array that is used as IL instructions inside the skeleton of the method. So inside these bitmaps, created by PuncherMachine.exe, there should be encoded a list of IL instructions.</p> <p>Seeing the assembly, it could easily be spotted what these instructions should be. The code does pretty much this:</p> <p><code class="language-plaintext highlighter-rouge">((x(0xDEAD,0xBEEF) ^ y(0xCAFE, 0xBABE)) ^ 0xFACE) ^ -229612108 == ToUInt32(“ESET”)</code></p> <p>You have to spot what functions x and y are. There is another unknown instruction at the end, but it is clear from the signature of the returned method that it is a ret.</p> <p>So it is very easy to spot the instructions:</p> <ul> <li>x = <strong>mul</strong> </li> <li>y = <strong>add</strong> </li> <li>z = <strong>ret</strong> </li> </ul> <p>Punching the bitmap with mul, add and ret does not let PunchCardReader.exe validate the bitmaps, although these seem to be the right strings. I spent very little time on this, but I think that it is due to the fact that the original bitmap is wrong, and this does not let the decoding process work well.</p> <p>If this assumption is correct, I think that two hypotheses are the most plausible:</p> <ol> <li>The re-implementation in C# of the VM program that runs inside the driver is bugged. At first glance, this seems unlikely to me because it produces an overall valid bitmap, but who knows.</li> <li>There is another bitmap that can be extracted from the 1st in some way (like trying to decrypt the content of the bitmap, XOR it, or whatever). That bitmap is the one that has the unknown hash and will allow the decoding process to work well. <h1 id="conclusion"> <a class="anchor" href="#conclusion" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusion</h1> <p>That’s all! After all, it is a nice crackme. I think the VM part is the best because it is very well written and stable. Kudos to the authors.</p> </li> </ol> <p>I am looking forward to the 2016 challenge bye.</p> <aside class="share"> <p>If you liked this article and think others should read it, please share it on <a href="http://twitter.com/share?text=ESET CrackMe Challenge 2015 - Walkthrough&amp;url=https://chaplin89.github.io/2016/ESET-CrackMe-Challenge-2015-Walkthrough/&amp;via=chaplinspace" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">Twitter</a> or <a href="https://www.facebook.com/sharer/sharer.php?u=https://chaplin89.github.io/2016/ESET-CrackMe-Challenge-2015-Walkthrough/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=235');return false;">Facebook</a>.</p> </aside> </div> </article> <aside id="comments" class="disqus"> <div class="container"> <h3><i class="icon icon-comments-o"></i> Comments</h3> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_shortname = 'chaplin89-github-io'; var disqus_identifier = '/2016/ESET-CrackMe-Challenge-2015-Walkthrough'; var disqus_title = 'ESET CrackMe Challenge 2015 - Walkthrough'; var disqus_url = 'https://chaplin89.github.io/2016/ESET-CrackMe-Challenge-2015-Walkthrough/'; /*var disqus_developer = 1;*/ (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript> Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a> </noscript> </div> </aside> </div> </div> <script type="text/javascript"> var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-141216446-1']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })(); </script> </body> </html>
